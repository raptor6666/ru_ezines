<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en"><head><script type="text/javascript" async="" src="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/ga.js"></script><script src="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/analytics.js" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app210.us.archive.org';v.server_ms=281;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/bundle-playback.js" charset="utf-8"></script>
<script type="text/javascript" src="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/wombat.js" charset="utf-8"></script>
<script>window.RufflePlayer=window.RufflePlayer||{};window.RufflePlayer.config={"autoplay":"on","unmuteOverlay":"hidden"};</script>
<script type="text/javascript" src="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/ruffle.js"></script>
<script type="text/javascript">
    __wm.pc(0.001);
    __wm.init("https://web.archive.org/web");
  __wm.wombat("http://nobunkum.ru:80/ru/tdss-analysis","20180429072921","https://web.archive.org/","web","https://web-static.archive.org/_static/",
	      "1524986961");
</script>
<link rel="stylesheet" type="text/css" href="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Анализ руткита TDSS</title>
  <!-- base href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/" -->
  <link rel="alternate" type="application/rss+xml" title="Журнал NO BUNKUM — Новости" href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/rss">
  <link rel="stylesheet" type="text/css" href="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/style.css">
<!--[if lt IE 8]>
<link rel="stylesheet" type="text/css" href="/template/css/ie.css" />
<![endif]-->
<!--[if IE 6]>
<link rel="stylesheet" type="text/css" href="/template/css/ie6.css" />
<![endif]-->
</head>
<body><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" lang="en" style="display: block; direction: ltr;">
</div><div id="wm-ipp-print">The Wayback Machine - https://web.archive.org/web/20180429072921/http://nobunkum.ru:80/ru/tdss-analysis</div>
<script type="text/javascript">//<![CDATA[
__wm.bt(725,27,25,2,"web","http://nobunkum.ru/ru/tdss-analysis","20180429072921",1996,"https://web-static.archive.org/_static/",["https://web-static.archive.org/_static/css/banner-styles.css?v=S1zqJCYt","https://web-static.archive.org/_static/css/iconochive.css?v=qtvMKcIJ"], false);
  __wm.rw(1);
//]]></script>
<!-- END WAYBACK TOOLBAR INSERT -->
 
      <div class="subscribe">
        
<form action="/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis" method="post">
<div>
<input class="mail" type="text" name="email" placeholder="newsletter">
<input type="hidden" name="groups[]" value="1">
<input class="submit" type="submit" value="OK"></div>
</form>
      </div>
  <div id="header">
    <div id="title">
      <a id="logo" href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/"><img src="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/logo.jpg" width="374" height="51" alt="NO BUNKUM"></a>
      <p>...on guns, germs, and steel of the digital age</p>
    </div>
    <div id="subtitle">
      <ul><li class="first"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/lookout/" title="Lookout" class="issue">Lookout</a></li>
<li><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/analytics/" title="Analytics" class="issue">Analytics</a></li>
<li class="current"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/" title="NO BUNKUM" class="issue">NO BUNKUM</a></li>
<li class="last"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/demo/" title="Demo" class="issue">Demo</a></li>
</ul>
      <div class="headerlinks">
        <a id="headerlink-about" href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/about" title="О журнале"><span>?</span></a>
        <a id="headerlink-rss" href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/rss" title="RSS"><span>RSS</span></a>
      </div>
    </div>
  </div>
  <div id="content">
    <div class="aside-long" style="text-align:center;padding:15px 10px">
      <span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=Exploit.SWF.Agent.br">Exploit.SWF.Agent.br</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=Pdfka.asd">Pdfka.asd</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=Pidief.cvl">Pidief.cvl</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight2"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=TDSS">TDSS</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=TDSS+removal">TDSS removal</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=binary+planting">binary planting</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=bios+infection">bios infection</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=blind+sqli">blind sqli</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=bootkit">bootkit</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=bootkit+remover">bootkit remover</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=browser+exploitation">browser exploitation</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=com+hijacking">com hijacking</a></span>
<span class="tl-tag tl-tag-weight4"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=disassembling">disassembling</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=dll+hijacking">dll hijacking</a></span>
<span class="tl-tag tl-tag-weight2"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=drive-by+downloads">drive-by downloads</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=hack+online+banks">hack online banks</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=heap-spray">heap-spray</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=hijack+botnet">hijack botnet</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=ibank">ibank</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=kernel+protection">kernel protection</a></span>
<span class="tl-tag tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=kernel-mode+rootkit">kernel-mode rootkit</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=keylogger">keylogger</a></span>
<span class="tl-tag tl-tag-weight5"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=malware+analysis">malware analysis</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight2"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=rootkit+detection">rootkit detection</a></span>
<span class="tl-tag tl-tag-weight3"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=trojan">trojan</a></span>
<span class="tl-tag tl-tag-alt tl-tag-weight1"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/tags?tag=virus+removal">virus removal</a></span>
    </div>
    <div id="content_text" style="margin-top: -10px;">
<div id="content_title"><h1>Анализ руткита TDSS</h1></div>
<div id="article_author" class="author">Алиса Шевченко, Esage Lab<br><a href="https://web.archive.org/web/20180429072921/mailto:alisa@esagelab.ru">alisa@esagelab.ru</a> / <a href="https://web.archive.org/web/20180429072921/http://twitter.com/alisaesage" target="_blank">@alisaesage</a></div>
<br>
<div style="padding-left: 14px;"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#intro">Вступление</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#overview">Обзор семейства</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#features">Характерные особенности</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#diversity">Внутривидовое разнообразие</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#analysis">Анализ кода</a> <br>
<div style="padding-left: 14px;"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#install">Инсталляция руткита и обход защиты</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#driver">Драйвер</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#rootkit">Rootkit-функционал</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#portal">Портал в пространство ядра</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#persistence">Устойчивость в системе</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#anti-av">Блокирование антивирусов</a></div>
<a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#removal">Удаление TDSS вручную</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#resume">Выводы и заключение</a> <br> 
<a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">Ссылки</a> <br> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#attachment">Приложения</a></div>
<a name="intro" style="text-decoration: none;"><h2>Вступление</h2></a>

<div class="aside">
<p></p><h4>Статья также доступна на <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/analytics/en-tdss-analysis">английском</a> языке</h4><p></p>
</div>

Руткит TDSS также известен под именами Tidserv, TDSServ и Alureon. 
Отдельные его компоненты детектируются антивирусами под другими именами,
 такими как Trojan.Win32.DNSChanger и Trojan.FakeAlert.<br> <br>Причины, по которым данный руткит удостоен детального исследования, таковы.<ol>
<li>Судя по огромному количеству "воплей о помощи" от пользователей на 
публичных форумах, большинство антивирусов не справляются с лечением 
руткита, хотя успешно его обнаруживают.<a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[1]</a></li>
<li>В публичном доступе нет полноценного описания функционала TDSS.</li>
<li>Реализация TDSS интересна тем, что, являясь со всей очевидностью 
эффективной, она не задействует никаких изощренных техник "нового 
поколения" или "0-day".</li>
<li>TDSS активно распространяется в живой среде, развиваясь в мощный 
ботнет. По данным Лаборатории Касперского за март-апрель 2009 г., в базы
 ежедневно добавляется от 100 до 300 сигнатур для новых и 
модифицированных файлов руткита. <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[2]</a></li>
</ol>Таким образом, руткит TDSS - угроза пограничного типа: он 
достаточно мощный для поражения антивирусных программ, но недостаточно 
опасный для детального исследования; достаточно распространенный для 
публичных криков о помощи, но не дотягивает до эпидемии.

<a name="overview" style="text-decoration: none;"><h2>Обзор семейства</h2></a>

ТDSS известен своей выдающейся способностью обходить активную защиту 
(антивирус, HIPS, фаервол), сложноудаляемостью и rootkit-функционалом. 
Его типичные наблюдаемые признаки в системе - всплывающие окна (pop-up),
 а также проблемы с запуском и обновлением антивирусных продуктов. На 
практике может иметь место любой функционал, что обеспечивается 
динамической подгрузкой дополнительных модулей.<br> <br> Первые 
прецеденты заражения руткитом зафиксированы в середине 2008 года. Уже 
тогда TDSS эффективно обходил защиты в процессе инсталляции. Учитывая, 
что разработчикам руткита удается поддерживать работоспособность этой 
функции уже почти год, вопреки обновлениям антивирусов, а также учитывая
 грамотность реализации и архитектуры кода - TDSS создан и развивается 
силами команды профессиональных разработчиков и в рамках ясной 
стратегии. <br> <br> Сам по себе TDSS - не более чем мощный загрузчик 
(downloader) с модульной архитектурой. Его основная задача - проникнуть 
на машину пользователя в обход защиты, хорошо закрепиться в системе, и в
 дальнейшем обеспечивать удаленное управление ресурсами зараженной 
машины, включая загрузку дополнительных функциональных модулей.<br> <br>
 Схема распространения TDSS не менее продуманна, чем его архитектура. 
Используется несколько каналов доставки вредоносного кода. Известные 
вектора атаки включают загрузку кода через web-эксплойт (iframe attack)<a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[3]</a>, инсталляцию его под видом видео-кодека <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[4]</a> для просмотра порнографии, а также распространение в связке с легитимными <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[5]</a> и пиратскими программами, генераторами ключей и crack'ами. <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[6]</a>

<a name="features" style="text-decoration: none;"><h2>Характерные особенности</h2></a>

<ul>
<li>Настоящее название руткита TDSS - 'TDL'. Более поздние образцы руткита называют себя 'TDL2'.</li>
<li>Файлы троянца защищены от анализа посредством несложной обфускации и шифрования.</li>
<li>Некоторые файлы отмечены поддельным штампом версии, характерным для программ Microsoft.</li>
<li>Основа механизма инсталляции TDSS - загрузка сервисом msiexec.exe 
(Microsoft Installer) своей собственной легитимной, но модифицированной 
DLL. <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[7]</a></li>
<li>После инсталляции руткит блокирует загрузку или обновление антивирусных программ.</li>
<li>Руткит тщательно закрепляется в системе, препятствуя деинсталляции. 
Например, некоторые модификации работают в режиме Safe Mode - это 
достигается модификацией ключей реестра 
HKLM\SYSTEM\ControlSet001\Control\SafeBoot\Minimal и 
HKLM\SYSTEM\ControlSet001\Control\SafeBoot\Network.</li>
<li>Руткит хранит свои настройки в реестре: список антивирусных модулей,
 которые необходимо блокировать, список собственных модулей, которые 
необходимо подгружать в адресное пространство браузера, и т.д.</li>
<li>Руткит скрывает свои файлы и ключи посредством перехвата нескольких функций.</li>
<li>Драйвер руткита открывает своим модулям окно в пространство ядра. 
Для этой цели используется вызов функции ZwFlushInstructionCache со 
специфическим набором аргументов.</li>
</ul>

<a name="diversity" style="text-decoration: none;"><h2>Внутривидовое разнообразие</h2></a>

Первые версии руткита в 2008 г. создавали в системе драйвер tdsserv.sys,
 от которого и произошло официальное имя TDSS. Впоследствии имя 
основного драйвера несколько раз менялось на clbdriver.sys, seneka*.sys,
 UACd*.sys, gaopdx*.sys, tdlserv.sys и другие.<br> <br> Первые версии 
руткита использовали патчинг библиотеки advapi32.dll, подгружаемой 
сервисом Microsoft Installer, в ходе инсталляции. Более новые версии 
используют патчинг библиотеки msi.dll. Возможно, это изменение – реакция
 на новые поведенческие сигнатуры систем защиты.<br> <br> Защита кода 
руткита от анализа выполнена в виде распаковщика, замаскированный под 
системный файл. При этом исполняемый файл визуально выглядит как большой
 кусок легитимного кода (отличающегося низкой энтропией в пределах 
байтового массива) с прицепленным в конце файла массивом данных (с 
высоким уровнем энтропии и без исполняемых инструкций). Исполняемый код 
украшен бессмысленными строками текста, призванными вызвать у поспешного
 аналитика ассоциации с системной утилитой. Не считая описанного 
«социального» трюка, защита кода не представляет интереса – это 
тривиально снимаемый «конверт», внутри которого спрятан оригинальный код
 троянца.<br> <br>Новейшие образцы эволюции TDSS содержат функционал 
червя. В частности, руткит пытается – и, судя по отзывам жертв, вполне 
успешно – размножаться через съемные накопители. С этой целью копия 
руткита размещается в директории RECYCLER в виде скрытого файла с именем
 .com, и создается ссылка на него в файле autorun.inf. Это приводит к 
автоматической загрузке руткита при подключении зараженного накопителя к
 системе (за исключением случаев, когда функция Autorun для внешних 
дисков запрещена в настройках системы), а также при попытке открытия 
зараженного накопителя из «Проводника».

<a name="analysis" style="text-decoration: none;"><h2>Анализ кода</h2></a>

Для анализа был использован экземпляр, обнаруженный примерно в Марте 2009 (MD5: 1DE66FC07C7B5893F5F83B397AC38F3D). <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[8]</a>
 Разновидность TDSS, представленная этим экземпляром, отмечена 
Российским филиалом лаборатории Symantec как один из наиболее 
упоминаемых вредоносных программ в марте 2009 г. <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[9]</a><br> <br> Общий алгоритм функционирования TDSS, характерный для семейства в целом, уже описан<a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[10]</a>,
 также как и основные механизмы компонентов руткита в ring3. Суммарный 
высокоуровневый обзор функционала конкретного файла можно найти поиском 
по MD5 в архиве любой публичной песочницы (например, ThreatExpert). 
Поэтому я опишу только самые важные механизмы и функционал уровня ядра.

<a name="install" style="text-decoration: none;"><h3>Инсталляция руткита и обход защиты</h3></a>

Процедура инсталляции руткита достойна упоминания, поскольку 
обеспечивает эффективный обход поведенческих защит и фаерволов. Ключевая
 идея алгоритма обхода – исполнение вредоносного кода в составе 
модифицированной системной библиотеки, автоматически подгружаемой 
легитимным системным сервисом. В результате такой манипуляции фаервол 
пропускает сетевую активность вредоносного кода в силу того, что его 
процесс-источник – системный сервис Windows – по умолчанию внесен в 
«белый список» и, как следствие, обладает всеми возможными привилегиями 
для загрузки и инсталляции файлов. Большинство проактивных защит также 
пропускают поведенческую активность руткита, поскольку она не 
вписывается в типичные паттерны нежелательного поведения.<br> <br> 
Технически этот алгоритм реализован следующим образом. Модификация 
системной библиотеки – advapi32.dll или, в более поздних версиях 
руткита, msi.dll – осуществляется в копии библиотеки на диске, которая 
затем загружается в директорию \KnownDLLs в памяти. После этого 
стандартными средствами запускается Microsoft Installer, который 
автоматически подгружает модифицированную библиотеку из \KnownDLLs. <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[11]</a>
<pre>// новая секция для кода инсталляции руткита
NtCreateSection(..”\knowndlls\dll.dll”..) 
// подготовка системной DLL к патчингу
CopyFile(..”msi.dll”, ..) 
// патчинг копии
WriteFile(.., ..) 
NtOpenSection(..”\knowndlls\msi.dll”..)
// убираем флаг OBJ_PERMANENT, чтобы система позволила 
// удалить объект msi.dll и создать его заново
NtMakeTemporaryObject(..) 
CloseHandle(..)
// создаем новый маппинг для msi.dll, загружая в него 
// модифицированную библиотеку
NtCreateSection(..”\knowndlls\msi.dll”, ..) 
..
// нормальный старт сервиса
StartService (..”Windows Installer”..) 

</pre>
В этой схеме модификация кода msi.dll минимальна, и обеспечивает только 
выполнение кода из секции \knowndlls\dll.dll, содержащей процедуры 
инсталляции руткита. Сам патч - &lt;malicious_code_injection&gt; - 
элегантен:
<pre>; адрес 7c906cbc - указатель на строку ‘dll.dll’ 
; на самом деле, это часть строки имени легитимного модуля ntdll.dll 
push 7c906cbc 
; в стек помещается адрес следующей за call инструкции
call $+5 
; после выполнения следующей инструкции первый dword на стеке 
; будет указывать на первую инструкцию патча. Таким образом, 
; вызов LoadLibrary вернется туда, где к тому времени будет 
; восстановлен оригинальный код
sub  dword ptr [esp], 0a 
mov eax, LoadLibrary
jmp eax ; вызов LoadLibrary (‘dll.dll’)</pre>
<p>Функционал секции dll.dll отображен на Рис.1.</p>
<div class="figure"><a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/images/tdss-analysis/fig1.gif"><img src="%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D1%80%D1%83%D1%82%D0%BA%D0%B8%D1%82%D0%B0%20TDSS_files/fig1.gif" alt="Основная задача этой библиотеки – загрузка и инсталляция драйвера руткита" width="500"></a>
<p>Рис. 1. Основная задача этой библиотеки – загрузка и инсталляция драйвера руткита.</p>
</div>

<a name="driver" style="text-decoration: none;"><h3>Драйвер</h3></a>

TDSS не имеет собственного процесса в пользовательском пространстве. 
Базовые функции обеспечиваются драйвером, который автоматически 
загружается на старте. Дополнительные высокоуровневые функции 
обеспечиваются отдельными DLL-модулями, внедряемыми в заданные процессы.
 <br><br>Функционал драйвера включает в себя:
<ul>
<li>сокрытие руткита</li>
<li>обеспечение «портала» в режим ядра</li>
<li>предотвращение загрузки антивирусов, перечисленных в конфигурационном ключе реестра</li>
<li>внедрение DLL-модулей в процессы, перечисленные в конфигурационном ключе</li>
<li>инсталляция новых DLL-модулей.</li>
</ul>
<a name="rootkit" style="text-decoration: none;"><h3>Rootkit-функционал</h3></a>
Руткит перехватывает методом сплайсинга следующие функции в пространстве ядра: <br> IofCallDriver<br> IofCompleteRequest<br> NtFlushInstructionCache<br> NtQueryVlaueKey<br> NtEnumerateKey<br> <br>
 Перехват NtEnumerateKey используется для сокрытия ключей реестра, 
отвечающих за загрузку и конфигурацию руткита (в данном случае это все 
ключи, начинающиеся со строки “gaopdx*”). Перехват NtQueryValueKey 
используется для подмены адресов DNS-серверов (значения ‘DhcpNameServer’
 и ‘NameServer’ <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[12]</a>)
 в реальном времени, без модификации реестра. Перехват IofCallDriver 
обеспечивает глобальную фильтрацию всех IRP в системе, что позволяет 
руткиту прятать свои файлы (начинающиеся со строки “gaopdx*”) всякий 
раз, когда он перехватывает IRP к драйверу файловой системы:
<pre>If ( FsRtlIsNameInExpression (..”*\\gaopdx*” or “*\\TEMP\\gaopdx*”..) )
then return (STATUS_TOO_MANY_SECRETS)</pre>
Перехват IofCompleteRequest обеспечивает схожий функционал.

<a name="portal" style="text-decoration: none;"><h3>Портал в пространство ядра</h3></a>

Перехват NtFlushInstructionCache несколько более любопытен, поскольку он
 служит порталом в ring0 для пользовательских модулей руткита. Для того 
чтобы воспользоваться порталом, данная функция вызывается со 
специфическим набором аргументов, которые включают магическое значение, 
команду и параметр к ней.
<pre>; аргумент к команде
push 0  
; команда (4 байта) – обеспечивает проверку работоспособности портала
push ‘VERG’ 
; магическое число, обеспечивающее выполнение процедуры перехватчика, 
; а не оригинальной API функции 
push ‘TDL2’ 
call ds:ZwFlushInstructionCache </pre>
Набор команд, обрабатываемых перехватчиком NtFlushInstructionCache, 
очень ограничен и не позволяет управлять руткитом. Доступные команды 
обеспечивают передачу переменных из ядра в пользовательский модуль, 
остановку заданного процесса или потока из ядра (посредством внедрения 
соответствующей задачи в очередь APC-вызовов ядра), и запуск процедур 
инсталляции нового dll-модуля.

<a name="persistence" style="text-decoration: none;"><h3>Устойчивость в системе</h3></a>

Драйвер вызывает функцию ExQueueWorkItem для запуска нескольких потоков в
 ядре. Потоки зациклены с периодом меньше секунды. Таким образом 
обеспечивается постоянная перерегистрация драйвера в системе 
(‘\registry\machine\system\currentcontrolset\services\gaopdxserv.sys’), 
отключение системного фаервола 
(‘\registry\machine\system\currentcontrolset\services\sharedaccess\parameters\firewallpolicy\’)
 и другие функции.

<a name="anti-av" style="text-decoration: none;"><h3>Блокирование антивирусов</h3></a>

Драйвер руткита посредством PsSetLoadImageNotifyRoutine инсталлирует 
процедуру нотификации, получающую управление по факту загрузки любого 
модуля в память. Внутри процедуры происходит сверка имени загружаемого 
модуля со списком запрещенных, перечисленных в ключе ‘disallowed’ 
настроек руткита в реестре. Загрузка запрещенных модулей блокируется.

<a name="removal" style="text-decoration: none;"><h2>Удаление TDSS вручную</h2></a>

Перечисленные ниже инструкции составляют универсальный алгоритм удаления
 любого варианта руткита TDSS. Для воплощения алгоритма не требуется ни 
специальных знаний, ни специфических утилит.<ol>
<li>В Device Manager (Компьютер → Управление устройствами), в разделе 
Non-PnP Driver, отключить и удалить драйвер руткита. Его можно 
локализовать по имени (tdsserv.sys, quadraserv.sys и т.д.). Поскольку 
полагаться на имя драйвера ненадежно – его лучше определить наверняка 
при помощи любого антируткита (GMER или Rootkit Unhooker 
предпочтительны; Avira Antirootkit также справляется с задачей). После 
этих манипуляций все файлы и ключи реестра руткита становятся видимыми и
 доступными для удаления вручную.</li>
<li>Удалить файл, соответствующий данному драйверу.</li>
<li>Удалить все ключи реестра, ссылающиеся на данный драйвер, и файлы 
дополнительных модулей, перечисленные в конфигурационном ключе.</li>
<li>Удалить (при их наличии) файлы autorun.inf и RECYCLER\*.com на всех дисках.</li>
<li>Перезагрузиться.</li>
<li>Использовать антивирус для окончательной очистки системы от возможных пропущенных файлов.</li>
</ol>Шаги 1-4 должны выполняться без помощи антивирусов, поскольку в 
случае отсутствия сигнатуры к какому-либо файлу дезинфекция не будет 
успешной.

<a name="resume" style="text-decoration: none;"><h2>Выводы и заключение</h2></a>

<ul>
<li>Эффективность TDSS демонстрирует, что для обхода систем защиты нет необходимости изобретать нетривиальные решения.</li>
<li>Разработчики вредоносных программ продолжают находить способы 
решения своих задач, основанные на обращении особенностей защиты в ее 
уязвимости. <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[13]</a></li>
<li>Распространение вредоносной программы в связке с легитимной – очень 
эффективная техника, хотя и не новая. Идея этой техники заключается в 
том, что если пользователь добровольно запускает приложение, которое 
считает легитимным – то он добровольно устранит всевозможные 
предупреждения от поведенческой защиты или UAC’a. Он также пропустит 
инсталляцию драйвера, поскольку для некоторых приложений (например, 
инсталлятора кодеков<a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/tdss-analysis#reference">[5]</a>)
 использование драйвера вполне ожидаемо. Кроме того, наличие видимого 
окна инсталлятора может ввести в заблуждение простую поведенческую 
защиту.</li>
</ul>
Разработчикам поведенческих защит и систем HIPS имеет смысл следить за действиями в системе, обеспечивающими эффективность TDSS.
<ul>
<li>Вызов функций NtOpenSection, NtMakeTemporaryObject и других API-интерфейсов к системным секциям.</li>
<li>Получение доступа к системным библиотекам (даже если это простое копирование).</li>
<li>Вызов LoadLibraryEx с параметром DONT_RESOLVE_DLL_REFERENCES (используется кодом dll.dll для восстановления кода msi.dll).</li>
<li>Модификация системной конфигурации DNS и DHCP.</li>
<li>Вызов PsSetLoadImageNotifyRoutine. Несмотря на высокую вероятность 
того, что к моменту вызова этой функции защита будет уже отключена – это
 не дает достаточных оснований для того, чтобы отказаться от контроля.</li>
</ul>
Очевидно, что перечисленные действия не могут расцениваться как 
вредоносные сами по себе. Тем не менее, они с существенной вероятностью 
могут составлять часть нежелательного поведения, и таким образом, должны
 входить в поведенческий паттерн детектирования в виде комбинаторной 
связки.

<a name="reference" style="text-decoration: none;"><h2>Ссылки</h2></a>

[1] Поиск Google, <a href="https://web.archive.org/web/20180429072921/http://www.google.com/search?q=tdss+%7C+tidserv+%7C+tdsserv+daterange:01012009-26042009+inurl:forum">отзывы пользователей о TDSS на форумах</a><br> [2] Лаборатория Касперского, <a href="https://web.archive.org/web/20180429072921/http://www.kaspersky.com/viruswatchlite?search_virus=TDSS">статистика по сигнатурам для TDSS</a><br> [3] Dancho Danchev, <a href="https://web.archive.org/web/20180429072921/http://ddanchev.blogspot.com/2009/01/embassy-of-india-in-spain-serving.html">Embassy of India in Spain Serving Malware</a> <br> Malware Analysis &amp; Diagnostic, <a href="https://web.archive.org/web/20180429072921/http://mad.internetpol.fr/archives/3-Etude-de-cas-Infection-rootkit-TDSS.html">Etude de cas - Infection rootkit TDSS</a> <br> [4] ThreatExpert, <a href="https://web.archive.org/web/20180429072921/http://www.threatexpert.com/report.aspx?md5=2c5c874235a73fc50a69780c7ad1488a">отчет о действиях программы с MD5=2c5c874235a73fc50a69780c7ad1488a</a> <br> [5] ThreatExpert, <a href="https://web.archive.org/web/20180429072921/http://www.threatexpert.com/report.aspx?md5=d2ada2dba8e036d37726ebddbcc9e9d6">отчет о действиях программы с MD5=d2ada2dba8e036d37726ebddbcc9e9d6</a> <br> [6] ThreatExpert, <a href="https://web.archive.org/web/20180429072921/http://www.threatexpert.com/report.aspx?md5=b17d76537ef5d94547fc4ca8851b35da">отчет о действиях программы с MD5=b17d76537ef5d94547fc4ca8851b35da</a> <br> [7] Symantec, <a href="https://web.archive.org/web/20180429072921/http://www.symantec.com/security_response/writeup.jsp?docid=2008-091809-0911-99&amp;tabid=2">Backdoor.Tidserv Technical Details</a> <br> [8] Virustotal.com, <a href="https://web.archive.org/web/20180429072921/http://www.virustotal.com/analisis/122e4ade1c0fa88cbab02880a3b2ed98">отчет о сканировании программы с MD5=1de66fc07c7b5893f5f83b397ac38f3d </a><br> [9] Anti-malware.ru, <a href="https://web.archive.org/web/20180429072921/http://www.anti-malware.ru/node/1250">История информационной безопасности за 4-ю неделю марта от Symantec</a> <br> [10] F-Secure, <a href="https://web.archive.org/web/20180429072921/http://www.f-secure.com/v-descs/backdoor_w32_tdss.shtml">Backdoor:W32/TDSS Virus Description</a> <br> [11] Microsoft Support, <a href="https://web.archive.org/web/20180429072921/http://support.microsoft.com/kb/164501">INFO: Windows NT/2000/XP Uses KnownDLLs Registry Entry to Find DLLs</a> <br> [12] MSDN, <a href="https://web.archive.org/web/20180429072921/http://technet.microsoft.com/en-us/library/cc962470.aspx">DhcpNameServer registry key</a> <br> [13] Virus Bulletin January 2009. Shevchenko A., <a href="https://web.archive.org/web/20180429072921/http://esagelab.ru/files/AlisaShevchenko-Jan09.pdf">Advanced malware techniques 2008</a>.

<a name="attachment" style="text-decoration: none;"><h2>Приложения</h2></a>

Экземпляр руткита TDSS и файлы анализа IDA (по запросу)<br> <a href="https://web.archive.org/web/20180429072921/http://www.esagelab.com/files/tdss_remover_latest.rar">Утилита для удаления руткита TDSS</a>

<p class="author" style="padding-left: 0px;"><br>Last updated: 17.03.2012</p>

</div>
  ﻿</div>
  <div id="footer">
    <p class="copyright">© 2009–2012 <a href="https://web.archive.org/web/20180429072921/http://www.nobunkum.ru/">NOBUNKUM</a> by <a href="https://web.archive.org/web/20180429072921/http://www.esagelab.ru/">Esage Lab</a> &nbsp;&nbsp;&nbsp;&nbsp;<a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/ru/">/на русском языке</a> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/about">/about</a> <a href="https://web.archive.org/web/20180429072921/http://nobunkum.ru/rss">/rss</a></p>
  </div>
  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3546318-9']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://web.archive.org/web/20180429072921/https://ssl' : 'https://web.archive.org/web/20180429072921/http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


</body></html>
<!--
     FILE ARCHIVED ON 07:29:21 Apr 29, 2018 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 12:22:55 May 30, 2024.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 0.583
  exclusion.robots: 0.142
  exclusion.robots.policy: 0.132
  esindex: 0.009
  cdx.remote: 6.6
  LoadShardBlock: 95.539 (3)
  PetaboxLoader3.datanode: 128.57 (4)
  PetaboxLoader3.resolve: 105.651 (2)
  load_resource: 152.237
-->